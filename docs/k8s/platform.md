k8s 是一个独特的容器编排系统，是一个 Pass，自身并不提供任何应用的功能，所以要使用 k8s，我们需要围绕着 k8s 搭建一系列的平台。

## 镜像管理平台

Harbor 是开源的镜像仓库，如果是私有云 Harbor 目前最流行的镜像仓库。如果又在使用公有云，可能会用到像 AWS 的 ECR，阿里云的 ACR等等。

## DevOps 平台

目前市面上有很多 CICD 工具，但是用的最多的工具还是 Jenkins，ArgoCD 和 fluxCD，而 ArgoCD 和 fluxCD 功能结合起来有一个项目名为 Flamingo。

工具搭建、编写执行程序，这些工作并不不是在使用平台的时候最重要，我认为最重要的是在使用之前想好如何使用这些工具。下面就要介绍以下 [12-factor](https://12factor.net/zh_cn/)，前人总结的一些云原生的最佳实践。

### 12factor

1. 基准代码

    一份基准代码，多分部署

2. 依赖

    显示生命依赖关系

3. 配置

    在环境中存储配置

4. 构建，发布，运行

    严格分离构建和运行

5. 进程

    以一个或者多个无状态的进程运行应用

6. 端口绑定

    通过端口绑定服务

7. 易处理

    快速启动和优雅终止可最大化健壮性

8. 开发环境与线上环境等价

    尽可能保持开发、预发布，线上环境相同。

9. 日志

    把日志当作事件流

10. 管理进程

    后台管理任务当作一次性进程运行


对应的 DevOps 流程可以从构建、发布、运行进行区分：

- 构建是就是在 Jenkins 上构建镜像上传到 Harbor 的过程
- 发布主要分为发布前的准备和发布时的处理
- 运行简单理解成应用发布成功，生产环境上线成功

区分完 DevOps 的主要流程之后，我们接下来就要根据 12-factor 聊聊如何进行 Git 管理和应用开发。

#### Git 管理

在 Git 管理时，我要维护一套基准代码然后部署到不同的环境中去，举个非常有借鉴意义的例子：[k8s-apiserver](https://github.com/kubernetes/apiserver)，此代码仓库为 k8s-apiserver 的代码仓库，该代码仓库中同时维护了 5 个分支，4个为版本分支和一个主分支。4个版本分支主要是维护目前 k8s 的长期支持的版本，主分支是为了后续的新版本发行。

就像我们搭建 k8s 集群那样，我们的 k8s 集群的任何版本可以充当生产环境和测试环境，这并不会对集群本身造成什么影响。搭建集群时，我们只要找好对应的版本即可，与之对应的就是 k8s-apiserver 仓库中的各个版本编号。这就是一份基准代码的多分代码。

另外在管理 Git 仓库的时候，我们需要按照功能去划分仓库，比如 k8s 的五个组件：k8s-apiserver、schedular、etcd、kube-proxy 和 kubelet 这 5 个组件分别对应了 5 个 Git 仓库，彼此之前没有相互干扰。


#### 应用开发

在微服务开发的时候，我们需要注意下几个方面：

- 开发无状态的应用接口：使用 RESTful API 的进行接口开发
- 声明依赖关系：目前经常使用的开发语音都会在开发过程中进行包管理
- 将一些经常修改的信息保存在配置文件里：比如数据库，kafka，后端接口地址等
- 将日志作为日志流进行输出：日志流输出，比如 Golang 的 Gin 框架，直接运行之后请求输出在 console 上面的日志，不需要在把日志写在某个文件中
- 快速启动和失败：需要开发探针接口，借助 k8s 的 Liveness 和 Readness 让应用在一段时间没启动成功就直接重新拉起一个新的 Pod。
- 端口绑定：每个服务都需要单独使用一个端口


## GitOps 平台

GitOps 的平台，我感觉主要是来贯彻基础设施即代码（IaC）这个理念。目前市面上比较主流的工具是 ArgoCD 和 fluxCD，这两个工具的主要区别是 fluxCD 可以支持 terraform，而 ArgoCD 没有直接的 terraform 引擎。但值得主义的点是任何平台的管理都离开权限管理。

借助 GitOps 平台，我们将把我们的镜像部署到 k8s 上面去。如果是多个 k8s 集群，我们还可以借助 karmada 这种类似的工具进行对多集群的管理，并部署应用。在应用部署的时候还可以定义蓝绿部署，金丝雀部署和滚动部署。

## 审计平台

k8s 的审计平台主要是来规范 k8s 内部的一些资源的定义情况，比如 deployment 必须要有 label 和 limit 这些字段，还有对 k8s 操作的记录。通常使用的工具有 keyverno 和 OPA，如果希望追踪公有云的合规性，直接使用公有云的服务即可，比如 AWS Config。

## 数据库平台

如果使用公有云，直接使用公有云的 RDS 即可，但是使用私有云的话，我们可能需要搭建自己的数据库管理平台（DBass），可以考虑直接使用 KubeBlocks 这种开源软件。

## 可观测性平台

最近在可观测性方面比较火的技术是 eBPF 和 Opentelmetry。但是要说比较出名的监控软件，肯定要数 Promtheus，监控用 Prometheuas 日志记录就要用 ELK 或者 EFK 了。但是目前也有其他新的监控软件，比方说 SigNoz 基于 Opentelemtry 的监控软件，Opentelmetry 可以将日志、metrics 和 trace 三个指标收集到一起。基于 eBPF 的 deepflow。

当我们在集群内布构建了各种各样的平台之后，我们可能一个应用运行之后，我们可能要登陆好几个网站去查看应用运行的情况。为此，我们可能要提供一个开发者门户，对此我们可能要考虑下借助 Backstage 去实现下开发者门户，然后发展一下公司内部的平台工程。

