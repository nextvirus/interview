etcd 是一个分布式的 key-value 存储数据库，是一个基于 raft 共识算法编写的数据库软件，k8s 以此作为持久化存储的方式。

## 什么是 raft 共识算法

raft 共识算法是分布式协议实现的一种，区块链中的 Pow 和 Pos 也是共识算法的一种。

要了解共识算法就要先了解分布式系统中的不可能三角 CAP ：

- Consistency：一致性，所有的副本在同一时间的数据一致
- Availability：可用性，系统中任何一个非故障节点接收到的每个请求都会得到响应，要么是请求的数据，要么是错误消息。换句话说，系统即使在节点故障的情况下也保持响应性。
- Partition tolerance：分区容错性，尽管可能发生节点之间的网络分区（通信故障），系统仍然可以继续运行。换句话说，系统能够处理某些节点之间无法通信的情况。

一个分布式系统不可能同时满足这三个方面。raft 算法是一个 CP 算法，它的设计目标是可理解性、易于实现以及能够提供强一致性。

Raft 算法通过引入领导者（leader）、跟随者（follower）和候选者（candidate）的角色来管理集群中的节点。在 Raft 中，所有节点通过选举产生一个领导者，领导者负责接收客户端的请求并将其复制到其他节点上。如果领导者失效，集群会重新选举一个新的领导者。

Raft 算法的核心包括：

1. Leader Election（领导者选举）：当没有领导者或者现有领导者失效时，集群中的节点会发起选举，通过投票选举出新的领导者。
2. Log Replication（日志复制）：领导者负责接收客户端的请求，将其追加到自己的日志中，并将日志条目发送给其他节点，要求其也复制这些条目。一旦大多数节点都确认复制了这些条目，领导者就可以将这些条目提交到自己的状态机中，并向客户端发送响应。
3. Safety Property（安全性）：Raft 算法确保了安全性，即任何已提交的日志条目都不会被覆盖或丢失，只要大多数节点是可达的，就不会出现分裂的情况。

Raft 算法的设计简单且易于理解，因此被广泛应用于构建分布式系统中的一致性模块，例如分布式数据库、分布式锁服务等。具体的动态效果图，可以在这个[链接](https://raft.github.io/)进行查看。